1. Objectif du document

Ce document décrit les procédures de reprise d’activité pour les serveurs ADFS en cas d’incident majeur ou de panne du site principal. Il détaille les étapes nécessaires pour basculer les services vers un site de secours, assurer la continuité des authentifications pour les applications dépendantes, puis restaurer le service principal.

2. Périmètre et contexte

Service concerné : ADFS (Active Directory Federation Services) pour l’authentification Single Sign-On (SSO).

Applications dépendantes : SharePoint, Office 365, autres applications d’entreprise nécessitant ADFS.

Environnement PRA : Basé sur Azure avec les composants suivants :

Azure Site Recovery (ASR) pour la réplication et le basculement.

Azure Traffic Manager pour le routage des demandes.

Load Balancers (Public et F5 Internal) pour équilibrer les charges et rediriger le trafic.


OS et version : Windows Server (version du système d’exploitation et des serveurs ADFS).


3. Schéma d’architecture

Inclure un schéma de l’architecture montrant :

Les serveurs ADFS dans le site principal et le site de secours.

La configuration des Load Balancers (internes et externes).

Le Traffic Manager configuré pour gérer les basculements.


4. Procédures de préparation

4.1 Configuration d’Azure Site Recovery

Étapes :

1. Configurer Azure Site Recovery pour répliquer les serveurs ADFS vers le site de secours.


2. Définir la fréquence de réplication en fonction des exigences de récupération (RPO).


3. Vérifier la synchronisation des données régulièrement.




4.2 Traffic Manager et Load Balancers

Traffic Manager :

Configurer le Traffic Manager pour basculer les requêtes d’authentification vers le site secondaire en cas de défaillance.


Load Balancers :

Configurer les Load Balancers publics et internes pour gérer la redirection du trafic ADFS.



5. Procédure de basculement (Failover)

En cas de sinistre sur le site principal :

5.1 Déclenchement du basculement avec Azure Site Recovery

Étapes :

1. Accéder au portail Azure et initier le basculement d’Azure Site Recovery vers le site de secours.


2. Valider l'état des serveurs ADFS sur le site de secours.




5.2 Activation du Traffic Manager et des Load Balancers

Assurez-vous que le Traffic Manager redirige les requêtes vers les Load Balancers du site de secours.

Configuration F5 Internal Load Balancer :

Vérifiez que les sessions utilisateurs sont redirigées sans perturbations majeures.



5.3 Vérification de la connectivité des applications

Testez l’accès des applications comme SharePoint et Office 365 pour confirmer que les utilisateurs peuvent s’authentifier.

Outils de surveillance : Utilisez les outils de monitoring pour détecter toute anomalie d’accès.


6. Test de basculement

6.1 Test de PRA

Planifiez des tests réguliers du PRA pour vérifier que la configuration fonctionne correctement et que le personnel est familiarisé avec les étapes de basculement.


6.2 Procédures de validation

Validez l’authentification des principales applications.

Documentez les éventuels problèmes rencontrés lors du test et apportez les corrections nécessaires.


7. Procédure de retour (Failback)

Une fois le site principal rétabli :

7.1 Préparation au retour

Assurez-vous que les serveurs ADFS du site principal sont en état de fonctionner et synchronisés avec le site secondaire.


7.2 Initiation du retour via Azure Site Recovery

Étapes :

1. Lancez le retour sur Azure Site Recovery pour basculer les services ADFS vers le site principal.


2. Désactivez les configurations de basculement du Traffic Manager pour rediriger les utilisateurs vers le site principal.




7.3 Vérification post-basculement

Testez les applications et les services pour s’assurer qu’ils fonctionnent correctement sur le site principal.

Surveillez les performances pour identifier d'éventuelles anomalies.


8. Surveillance continue et alertes

Configurez des alertes sur Azure pour être notifié des problèmes potentiels avec les serveurs ADFS.

Mettez en place un suivi de la disponibilité et de la performance des serveurs pour garantir leur bon fonctionnement.


9. Documentation des incidents et analyse post-sinistre

9.1 Rapport de basculement

Documentez l’incident, les actions entreprises et les performances du plan PRA.

Évaluez le succès du basculement et identifiez les améliorations possibles.


9.2 Revue post-sinistre

Réunissez les parties prenantes pour analyser les résultats et mettre à jour les procédures PRA.


10. Annexes

Liste des contacts : Équipe IT, fournisseurs, gestionnaires de services cloud.

Documentation technique : Références pour la configuration d’Azure Site Recovery, Traffic Manager et Load Balancers.

Journal des tests PRA : Historique des tests avec date, résultat, et améliorations apportées.

ChatGPT

Vous avez dit :
Bonjour,
Concernant le message d'erruer qui s'affiche dans l'acceuil des vls qui execute le nas " virtuel machine agent qtatus not ready." J'ai fait mes recherches et la seul explication logique que j'ai eu de la part de kb de netapp c'est que l'image ne support pas les extensions azure monitor, dans notre cas l'extension network wotcher est installé automatiquement dans ces deux vms. Je propose de d'essayer de désactiver les extensions networkwoatcher des vm nas, et de créer une policy qui empêche l'installation des ces extention dans les machines designer pour garantir n'est pas avoir des solution.
ChatGPT a dit :
ChatGPT
Voici une version révisée de votre message pour plus de clarté et de précision :

Bonjour,

Concernant le message d’erreur affiché sur les VMs NAS à l’accueil : "Virtual Machine Agent Status Not Ready", j’ai mené des recherches approfondies. D’après les articles de la base de connaissances NetApp, il semble que l’image utilisée ne supporte pas les extensions Azure Monitor.

Dans notre cas, l’extension Network Watcher est installée automatiquement sur ces deux VMs. Je propose donc :

De désactiver manuellement l’extension Network Watcher sur les VMs NAS.
De créer une policy Azure empêchant l’installation automatique de cette extension sur les machines virtuelles NAS pour garantir une stabilité à long terme.
Merci de me faire savoir si vous validez cette approche ou si vous souhaitez explorer d’autres solutions.

Cordialement,
Ihsen


Service concerné :
ADFS (Active Directory Federation Services) exécuté sur deux machines virtuelles (vmw0infiam050 avec une adresse IP privée 10.238.4.105 et vmw0infiam040 avec une adresse IP privée 10.238.4.104) regroupées dans un Availability Set réparti entre la Zone 1 et la Zone 3.

Applications dépendantes :

Environnement PRA :
Le Plan de Reprise d'Activité (PRA) est basé sur Azure et repose sur les composants suivants :

Azure Site Recovery (ASR) :

Permet la réplication et le basculement des machines virtuelles.
En cas de sinistre, le basculement sera effectué à partir des deux serveurs ADFS en Availability Set du site primaire (AMSTERDAM) vers un serveur ADFS de secours déjà répliqué avec ASR dans la zone de récupération (DUBLIN).
Le serveur de secours, nommé vmw0infiam100, utilise une adresse IP privée 10.238.192.68.
La réplication des disques est également gérée par ASR.
Le réseau cible dans la zone de récupération est nommé vnt0infiam100.
Azure Traffic Manager :

Utilisé pour distribuer le trafic selon une stratégie de routage basée sur la priorité.
Le profil Traffic Manager contient deux points de terminaison :
adfs-proxy-korian avec une priorité 200 (point de terminaison principal).
adfs-proxy-korian-dublin avec une priorité 300 (point de terminaison secondaire).
Par défaut, Traffic Manager dirige tout le trafic vers le point de terminaison principal (adfs-proxy-korian).
Si le point de terminaison principal devient indisponible, il est automatiquement désactivé ou sa priorité est modifiée pour que Traffic Manager redirige le trafic vers le point de terminaison secondaire (adfs-proxy-korian-dublin).
La disponibilité des points de terminaison est déterminée en fonction de leur état configuré (activé ou désactivé)
Bonjour,

J'ai fixé un créneau avec Anthony pour analyser les machines virtuelles susceptibles d’être redimensionnées. Nous baserons cette analyse sur les données d’Azure Monitor sur une période maximale d’un mois.

Si vous êtes d’accord, je pourrais ensuite réaliser une étude financière et technique afin de proposer des solutions : soit le redimensionnement des machines surdimensionnées, soit la création de machines virtuelles dans un scale set. Cela permettrait de garantir les performances souhaitées grâce à la scalabilité horizontale, tout en réalisant des économies financières sur le long terme.

Cordialement,

Bonjour,

Advisot m'a fourni une liste des VMs identifiées comme surdimensionnées. Cela constitue un bon point de départ. J'ai commencé par formater cette liste et ne conserver que les VMs ayant une utilisation du CPU inférieure à 20 % et une utilisation de la mémoire inférieure à 33 %.

Ensuite, j'ai proposé des redimensionnements dans la même catégorie de machines virtuelles, afin d'éviter toute surprise.

En tout cas, il est très intéressant de suivre ce chantier d’optimisation, car cela permet d'améliorer les performances tout en réduisant les coûts. Cependant, cette démarche nécessite des études approfondies et une planification rigoureuse.

C’est un projet qui, bien mené, peut s’avérer très rentable.
Plan de Reprise d'Activité - Serveur PKI
1. Introduction
Objectif du document : Définir les étapes et procédures pour rétablir le service PKI en cas de sinistre.
Périmètre : Serveur(s) PKI, dépendances (base de données, HSM, services réseau, etc.).
Public concerné : Équipe IT, Responsable Sécurité SI, Administrateurs PKI.
2. Description de l'environnement PKI
Architecture actuelle :
Liste des serveurs PKI (racine, intermédiaire, de publication CRL, etc.).
Services associés : OCSP, CRL, HSM, base de données.
Emplacement physique : Data centers primaires et secondaires.
Dépendances : DNS, Active Directory, sauvegardes.
Logiciels et versions : Ex. Microsoft CA, EJBCA, etc.
3. Analyse des risques et impacts
Scénarios de sinistre :
Panne matérielle.
Corruption de données.
Cyberattaque.
Sinistre naturel (incendie, inondation).
Impacts métier :
Interruption des validations de certificats.
Perte de confiance des utilisateurs et partenaires.
Risques de non-conformité (RGPD, eIDAS, etc.).
4. Stratégie de reprise
Objectifs clés :
RPO (Recovery Point Objective) : Par exemple, 1 heure.
RTO (Recovery Time Objective) : Par exemple, 4 heures.
Solution mise en place :
Réplication des données vers un site secondaire.
Redondance des serveurs (cluster ou infrastructure active/passive).
Sauvegarde régulière de la base de données PKI et des certificats.
5. Préparation et prérequis
Inventaire des ressources :
Serveurs physiques/virtuels et configurations.
Licences logicielles et clés HSM.
Sauvegardes :
Localisation des sauvegardes (on-premises/cloud).
Fréquence : quotidienne ou hebdomadaire.
Contenu : certificats, clés privées, configurations CA.
Tests préventifs :
Vérification régulière des sauvegardes.
Test de restauration dans un environnement isolé.
6. Procédures de reprise
6.1. Détection et notification
Identification de l'incident par les équipes ou monitoring.
Notification au Responsable PKI et à l'équipe de gestion de crise.
6.2. Étapes de restauration
Évaluation de l'incident :
Nature et gravité du sinistre.
Disponibilité des sauvegardes.
Activation du PRA :
Déploiement du serveur de secours (site secondaire ou machine virtuelle).
Restauration des données (certificats, clés, configurations).
Redémarrage des services :
Service OCSP.
Publication des listes CRL.
Validation des connexions réseau et DNS.
Vérification :
Test des certificats émis/validés.
Validation par les utilisateurs finaux.
6.3. Transition au mode normal
Remise en ligne du site principal si possible.
Synchronisation des données entre les sites.
7. Gestion post-incident
Rapport d'incident :
Cause principale identifiée.
Actions correctives prises.
Audit et amélioration :
Analyse des écarts dans le PRA.
Mise à jour du plan selon les leçons apprises.
8. Rôles et responsabilités
Rôle	Responsabilité
Administrateur PKI	Gestion technique des serveurs PKI
Responsable PRA	Coordination des activités de reprise
Responsable Sécurité	Supervision des aspects de sécurité
Équipe d'infrastructure	Assistance pour la restauration matérielle/virtuelle
9. Annexes
Diagramme d'architecture PKI.
Contacts d'urgence (fournisseurs, support HSM, équipes internes).
Modèles de logs de restauration.
Ce document doit être testé et révisé régulièrement (par exemple, une fois par an ou après chaque incident). Si besoin, je peux fournir un modèle détaillé au format Word.











ChatGPT peut faire des erreurs. Envisagez de vérifier les in

