#!/bin/bash

# Définir l'abonnement Azure (si nécessaire)
# az account set --subscription "VOTRE_ID_ABONNEMENT"

# Obtenir la liste des comptes de stockage dans l'abonnement
storage_accounts=$(az storage account list --query "[].{name:name, resourceGroup:resourceGroup}" -o tsv)

# Parcourir chaque compte de stockage
while IFS=$'\t' read -r storage_account resource_group; do
    echo "Compte de stockage: $storage_account (Groupe de ressources: $resource_group)"

    # Obtenir la liste des partages de fichiers dans le compte de stockage
    file_shares=$(az storage share list --account-name "$storage_account" --query "[].{name:name}" -o tsv)

    # Parcourir chaque partage de fichiers
    while IFS=$'\t' read -r file_share; do
        # Obtenir les détails du partage de fichiers
        share_details=$(az storage share show --name "$file_share" --account-name "$storage_account" --query "{size:properties.quota, lastModified:properties.lastModified}" -o json)

        # Extraire la taille et la date de modification
        size=$(echo "$share_details" | jq -r '.size')
        last_modified=$(echo "$share_details" | jq -r '.lastModified')

        # Afficher les informations du partage de fichiers
        echo "  Partage de fichiers: $file_share"
        echo "    Taille: $size Go"
        echo "    Dernière modification: $last_modified"
    done <<< "$file_shares"

    echo ""
done <<< "$storage_accounts"
