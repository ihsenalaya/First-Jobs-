#!/bin/bash

# Définir l'ID de l'abonnement Azure si besoin
# az account set --subscription "VOTRE_ID_ABONNEMENT"

# Obtenir la liste des comptes de stockage dans l'abonnement :
storage_accounts=$(az storage account list --query "[].{name:name, resourceGroup:resourceGroup}" -o tsv)

# Parcourir chaque compte de stockage :
while IFS=$'\t' read -r storage_account resource_group; do
    echo "------------------------------------------------------------"
    echo "Compte de stockage : $storage_account"
    echo "Groupe de ressources : $resource_group"
    echo "------------------------------------------------------------"

    # Obtenir la liste des File Shares dans le compte de stockage :
    file_shares=$(az storage share list \
        --account-name "$storage_account" \
        --query "[].name" \
        -o tsv)

    # Parcourir chaque File Share :
    while IFS= read -r file_share; do
        # Récupérer les détails du File Share (quota et date de dernière modification) :
        share_details=$(az storage share show \
            --account-name "$storage_account" \
            --name "$file_share" \
            --query "{size:properties.quota, lastModified:properties.lastModified}" \
            -o json)

        # Extraire la taille (quota) et la date de dernière modification :
        size=$(echo "$share_details" | jq -r '.size')
        last_modified=$(echo "$share_details" | jq -r '.lastModified')

        # Afficher les informations :
        echo "  - File Share         : $file_share"
        echo "    * Taille (quota)   : ${size} Go"
        echo "    * Dernière modif.  : $last_modified"
        echo ""
    done <<< "$file_shares"

done <<< "$storage_accounts"
